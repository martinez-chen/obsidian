#redis #session #login

1.  ## 發送訊息驗證碼
	### session 
	```mermaid 
	graph LR 
	
	A[開始] --> B(送出手機號碼)
	    B --> C{驗證手機號碼}
	    C --> |不符合| B(送出手機號碼)
	    C --> |符合| E[生成驗證碼]
	    E --> F(保存驗證碼到session)
	    F --> G(發送驗證碼)
	    G --> Ｈ[結束]
	```

	### redis
	
	```mermaid 
		graph LR 
		
		A[開始] --> B(送出手機號碼)
		    B --> C{驗證手機號碼}
		    C --> |不符合| B(送出手機號碼)
		    C --> |符合| E[生成驗證碼]
		    E --> F(保存驗證碼到redis)
		    F --> G(發送驗證碼)
		    G --> Ｈ[結束]
	```
	
2. 訊息驗證碼登入、註冊
	### session
	```mermaid 
	graph LR 
	
	A[開始] --> B(送出手機號碼和驗證碼)
		B --> C{檢查驗證碼}
		C --> |不一致| B(送出手機號碼和驗證碼)
		C --> |一致| D(根據手機號碼查詢用戶)
		D --> E{用戶是否存在}
		E --> |不存在| F(建立新用戶)
		F --> H(保存用戶到資料庫)
		H --> G(保存到session)
		E --> |存在| G(保存到session)
		G --> I[結束]
	```
	### redis
	```mermaid 
	graph LR 
	
	A[開始] --> B(送出手機號碼和驗證碼)
		B --> C{讀取redis檢查驗證碼}
		C --> |不一致| B(送出手機號碼和驗證碼)
		C --> |一致| D(根據手機號碼查詢用戶)
		D --> E{用戶是否存在}
		E --> |不存在| F(建立新用戶)
		F --> H(保存用戶到資料庫)
		H --> G(保存到redis)
		E --> |存在| G(保存到redis)
		G --> I(返回token給客戶端)
		I --> J[結束]
	```
3. 驗證登入狀態
	### session
	```mermaid 
	graph LR 
	
	A[開始] --> B(請求並攜帶 cookie)
		B --> C(從session獲得用戶資訊)
		C -->  D{判斷用戶是否存在}
		D --> |存在|E(保存用戶到ThreadLocal)
		E --> G(放行)
		D --> |不存在| F(攔截)
		G --> H[結束]
		F --> H[結束]
	```
	### redis
	```mermaid 
	graph LR 
	
	A[開始] --> B(請求並攜帶 token)
		B --> C(從redis獲得用戶資訊)
		C -->  D{判斷用戶是否存在}
		D --> |存在|E(保存用戶到ThreadLocal)
		E --> G(放行)
		D --> |不存在| F(攔截)
		G --> H[結束]
		F --> H[結束]
	```


> [!NOTE] 優化登入攔截器
> 當用戶一直使用不需登入的畫面，則無法被攔截器攔截
> 攔截所有路徑，處理刷新token
> 攔截需登入路徑，處理驗證功能
>  [[責任鏈模式 Chain of Responsibility Pattern]]
